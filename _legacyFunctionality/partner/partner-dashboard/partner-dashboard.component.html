<div class="dashboard-container">
  <!-- Header -->
  <header class="dashboard-header">
    <div class="logo"></div>
    <div class="user-profile">
      <img />
      <button class="logout-button" (click)="logout()">Logout</button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="dashboard-main">
    <h2 class="video-survey-header">
      Video Survey
    </h2>
    <p class="dashboard-description">
      Upload a video of your household items to generate a comprehensive <b>digital manifest</b>.
      <br>
      Simply select a video file or record directly from your device.
    </p>

    <!-- Upload Options Area -->
    <div class="upload-options-area">
      <div class="upload-option" (click)="fileUploadInput.click()">
        <input
          type="file"
          #fileUploadInput
          (change)="onFileSelected($event)"
          hidden
          accept="video/*"
        />
        <p>Upload a video file</p>
        <p class="small-text">Only small files less than {{this.MAX_FILE_SIZE_MB}} MB are supported</p>
      </div>

      <div class="upload-option" (click)="cameraInput.click()">
        <input
          type="file"
          #cameraInput
          (change)="onFileSelected($event)"
          hidden
          accept="video/*"
          capture="environment"
        />
        <p>Record directly</p>
        <p class="small-text">Set your camera settings to a lower resolution (30 FPS, 480p-720p)</p>
      </div>
    </div>

    <!-- New Upload Preview and Confirmation Section -->
    <div *ngIf="selectedFile" class="upload-preview-container">
      <h4 class="preview-header">Upload Confirmation</h4>
      <div class="preview-content">
        <div class="video-preview">
          <video [src]="filePreviewUrl" controls></video>
        </div>
        <div class="upload-form">
          <div class="form-group">
            <label for="customFileName">File Name</label>
            <input
              id="customFileName"
              type="text"
              [(ngModel)]="customFileName"
              placeholder="Enter a custom name for your video"
              [disabled]="isUploading"
            />
          </div>
          <div class="upload-actions">
            <button
              class="action-button primary-button"
              (click)="onUpload()"
              [disabled]="isUploading || !customFileName"
            >
              {{ isUploading ? 'Uploading...' : 'Confirm & Upload' }}
            </button>
            <button
              class="action-button cancel-button"
              (click)="cancelSelection()"
              [disabled]="isUploading"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
      <!-- Upload Status with Spinner -->
      <div *ngIf="isUploading" class="upload-progress-section">
        <p class="status-message">
          {{ uploadStatusMessage }}
          <span class="inline-spinner text-primary" role="status" aria-hidden="true"></span>
        </p>
      </div>
    </div>

    <!-- Survey List -->
    <div class="survey-list">
      <h3>Recent Uploads</h3>
      <div *ngIf="isLoadingUploads" class="loading-spinner-container">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading uploads...</span>
        </div>
        <p>Loading uploads...</p>
      </div>
      <ng-container *ngIf="!isLoadingUploads">
        <div class="upload-item-card" *ngFor="let upload of uploads">
          <div class="item-details">
            <span class="video-name">{{ upload.fileName || upload.videoName }}</span>
            <span class="timestamp">{{ upload.createdTimestamp | date: 'short' }}</span>
          </div>
          <div class="item-status">
            <span
              *ngIf="upload.status !== 'Completed'"
              class="status-badge"
              [ngClass]="getStatusClass(upload.status)"
            >
              {{ upload.status }}
              <span
                *ngIf="upload.status === 'Pending' || upload.status === 'Processing' || upload.status === 'Queued'"
                class="inline-spinner text-primary"
                role="status"
                aria-hidden="true"
              ></span>
            </span>
          </div>
          <div class="item-actions">
            <button
              *ngIf="upload.status === 'Completed'"
              class="action-button primary-button"
              (click)="openDigitalManifest(upload.uploadId)"
            >
              Get Digital Manifest
            </button>
            <button
              *ngIf="upload.status === 'Failed'"
              class="action-button retry-button"
              (click)="retryUpload(upload.uploadId)"
            >
              Retry
            </button>
          </div>
        </div>
        <p *ngIf="uploads.length === 0" class="no-uploads">No uploads yet.</p>
      </ng-container>
    </div>
  </main>
</div>

<!-- Digital Manifest Modal -->
<app-digital-manifest-modal
  *ngIf="isModalOpen"
  [manifestData]="selectedManifest"
  [isLoading]="isLoadingManifest"
  (closeModal)="closeDigitalManifest()"
>
</app-digital-manifest-modal>
